{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "use-captions",
  "dependencies": [
    "zustand"
  ],
  "registryDependencies": [
    "https://limeplay.winoffrg.dev/r/use-player.json",
    "https://limeplay.winoffrg.dev/r/use-playback.json",
    "https://limeplay.winoffrg.dev/r/utils.json",
    "https://limeplay.winoffrg.dev/r/media-provider.json",
    "https://limeplay.winoffrg.dev/r/player-hooks.json"
  ],
  "files": [
    {
      "path": "registry/default/hooks/use-captions.ts",
      "content": "\"use client\"\n\nimport type shaka from \"shaka-player\"\nimport type { StateCreator } from \"zustand\"\n\nimport { useCallback, useEffect } from \"react\"\n\nimport type { PlaybackStore } from \"@/registry/default/hooks/use-playback\"\n\nimport { getDeviceLanguage, off, on } from \"@/registry/default/lib/utils\"\nimport {\n  useGetStore,\n  useMediaStore,\n} from \"@/registry/default/ui/media-provider\"\n\nexport interface CaptionsStore {\n  activeTextTrack: null | shaka.extern.TextTrack\n  onCaptionsChange?: (payload: {\n    track?: shaka.extern.TextTrack\n    visible: boolean\n  }) => void\n  onTextTrackChange?: (payload: { track?: shaka.extern.TextTrack }) => void\n  setTextTrackContainerElement: (ref: HTMLDivElement | null) => void\n\n  textTrackContainerElement: HTMLDivElement | null\n  textTracks?: shaka.extern.TextTrack[]\n\n  textTrackVisible: boolean\n}\n\nexport const createCaptionsStore: StateCreator<\n  CaptionsStore & PlaybackStore,\n  [],\n  [],\n  CaptionsStore\n> = (set) => ({\n  activeTextTrack: null,\n  onCaptionsChange: undefined,\n  onTextTrackChange: undefined,\n  setTextTrackContainerElement: (element: HTMLDivElement | null) => {\n    set({\n      textTrackContainerElement: element,\n    })\n  },\n\n  textTrackContainerElement: null,\n  textTracks: undefined,\n\n  textTrackVisible: false,\n})\n\nexport interface UseCaptionsReturn {\n  toggleCaptionVisibility: () => void\n}\n\nexport function useCaptions(): UseCaptionsReturn {\n  const store = useGetStore()\n  const player = useMediaStore((s) => s.player)\n  const activeTextTrack = useMediaStore((s) => s.activeTextTrack)\n  const textTracks = useMediaStore((s) => s.textTracks)\n\n  const findDefaultTrack = useCallback(() => {\n    if (!textTracks) {\n      console.warn(\"No text tracks found\")\n      return\n    }\n\n    if (textTracks.length === 1) {\n      return textTracks[0]\n    }\n\n    const deviceLanguage = getDeviceLanguage()\n\n    const regionalTrack = textTracks.find(\n      (track) => track.language === deviceLanguage\n    )\n\n    if (regionalTrack) {\n      return regionalTrack\n    }\n\n    return textTracks[0]\n  }, [textTracks])\n\n  const selectTrack = useCallback(\n    (track: shaka.extern.TextTrack) => {\n      if (!player || !textTracks) {\n        return false\n      }\n\n      player.selectTextTrack(track)\n\n      const activeTextTrack = player\n        .getTextTracks()\n        .find((t: shaka.extern.TextTrack) => t.active)\n\n      store.setState({ activeTextTrack })\n\n      return true\n    },\n    [player, textTracks]\n  )\n\n  const toggleCaptionVisibility = () => {\n    if (!player) {\n      return\n    }\n\n    if (!activeTextTrack) {\n      const defaultTrack = findDefaultTrack()\n      if (defaultTrack) {\n        const isSuccess = selectTrack(defaultTrack)\n\n        if (!isSuccess) {\n          console.error(\"Failed to select default text track\")\n          return\n        }\n      }\n    }\n\n    const isVisible = store.getState().textTrackVisible\n    player.setTextTrackVisibility(!isVisible)\n  }\n\n  return {\n    toggleCaptionVisibility,\n  }\n}\n\nexport function useCaptionsStates() {\n  const store = useGetStore()\n  const player = useMediaStore((s) => s.player)\n  const containerElement = useMediaStore((s) => s.textTrackContainerElement)\n  const mediaRef = useMediaStore((state) => state.mediaRef)\n  const canPlay = useMediaStore((state) => state.canPlay)\n\n  const onTextTrackChanged = () => {\n    if (!player) {\n      return\n    }\n\n    const activeTextTrack = player\n      .getTextTracks()\n      .find((t: shaka.extern.TextTrack) => t.active)\n\n    store.setState({ activeTextTrack })\n\n    store.getState().onTextTrackChange?.({ track: activeTextTrack })\n  }\n\n  const onTracksChanged = () => {\n    if (!player) {\n      return\n    }\n\n    const tracks = player.getTextTracks()\n    store.setState({ textTracks: tracks })\n  }\n\n  const onTextTrackVisibility = () => {\n    if (!player) {\n      return\n    }\n\n    const isVisible = player.isTextTrackVisible()\n    const activeTrack = store.getState().activeTextTrack\n\n    store.setState({ textTrackVisible: isVisible })\n\n    store.getState().onCaptionsChange?.({\n      track: activeTrack || undefined,\n      visible: isVisible,\n    })\n  }\n\n  useEffect(() => {\n    if (!player || !containerElement) {\n      return\n    }\n\n    player.setVideoContainer(containerElement)\n  }, [containerElement, player])\n\n  useEffect(() => {\n    if (!mediaRef.current || !player) return\n\n    if (canPlay) {\n      onTracksChanged()\n    }\n\n    on(player, \"textchanged\", onTextTrackChanged)\n    on(player, [\"trackschanged\", \"loading\"], onTracksChanged)\n    on(player, \"texttrackvisibility\", onTextTrackVisibility)\n\n    return () => {\n      off(player, \"textchanged\", onTextTrackChanged)\n      off(player, [\"trackschanged\", \"loading\"], onTracksChanged)\n      off(player, \"texttrackvisibility\", onTextTrackVisibility)\n    }\n  }, [mediaRef, player, canPlay])\n}\n",
      "type": "registry:hook",
      "target": "hooks/limeplay/use-captions.ts"
    }
  ],
  "type": "registry:hook"
}